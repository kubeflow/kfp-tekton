# Compiler for Tekton

There is an [SDK](https://www.kubeflow.org/docs/pipelines/sdk/sdk-overview/) 
for `Kubeflow Pipeline` for end users to define end to end machine learning and data pipelines.
The output of the KFP SDK compiler is YAML for [Argo](https://github.com/argoproj/argo).

We are updating the `Compiler` of the KFP SDK to generate `Tekton` YAML. Please go through the steps below
to ensure you are set up properly to use the KFP-Tekton compiler.


## Table of Contents

<!-- START of ToC generated by running ./tools/mdtoc.sh sdk/README.md -->

  - [Project Prerequisites](#project-prerequisites)
  - [Tested Pipelines](#tested-pipelines)
  - [How to use the KFP-Tekton Compiler](#how-to-use-the-kfp-tekton-compiler)
  - [Build Tekton from Master](#build-tekton-from-master)
  - [Additional Features](#additional-features)
    - [1. TODO: remove/restructure: Compile Kubeflow Pipelines as a Tekton PipelineRun](#1-compile-kubeflow-pipelines-as-a-tekton-pipelinerun)
    - [2. Compile Kubeflow Pipelines with Artifacts Enabled](#2-compile-kubeflow-pipelines-with-artifacts-enabled)
  - [List of Available Features](#list-of-available-features)
  - [Troubleshooting](#troubleshooting)

<!-- END of ToC generated by running ./tools/mdtoc.sh sdk/README.md -->


## Project Prerequisites

 - Python: `3.7.5`
 - Kubeflow Pipelines: [`0.5.0`](https://github.com/kubeflow/pipelines/releases/tag/0.5.0)
 - Tekton: [`0.11.3`](https://github.com/tektoncd/pipeline/releases/tag/v0.11.3)
 - Tekton CLI: [`0.8.0`](https://github.com/tektoncd/cli/releases/tag/v0.8.0)

Follow the instructions for [installing project prerequisites](/sdk/python/README.md#development-prerequisites)
and take note of some important caveats.


## Tested Pipelines

We are [testing the compiler](/sdk/python/tests/README.md) on more than 80 pipelines found in the Kubeflow Pipelines
repository, specifically the pipelines in KFP compiler `testdata` folder, the KFP core samples and the samples
contributed by third parties.

A report card of Kubeflow Pipelines samples that are currently supported by the `kfp-tekton` compiler can be found
[here](/sdk/python/tests/test_kfp_samples_report.txt). As you work on a PR that enables another of the missing features
please ensure that your code changes are improving the number of successfully compiled KFP pipeline samples.


## How to use the KFP-Tekton Compiler

1. Clone the `kfp-tekton` repo:

    - `git clone https://github.com/kubeflow/kfp-tekton.git`
    - `cd kfp-tekton`

2. Setup Python environment with Conda or a Python virtual environment:

    - `python3 -m venv .venv`
    - `source .venv/bin/activate`

3. Build the compiler:

    - `pip install -e sdk/python`

4. Run the compiler tests (optional):

    - `make test`

5. Compile the sample pipeline:
 
    - `dsl-compile-tekton --py sdk/python/tests/compiler/testdata/parallel_join.py --output pipeline.yaml`
    
6. Run the sample pipeline on a Tekton cluster:

    - `kubectl apply -f pipeline.yaml`
    - `tkn pipelinerun logs --last`

   You should see the logs of the running Tekton Pipeline streamed, similar to the one below
      
      ```bash
      Waiting for logs to be available...

      [gcs-download-2 : main] I find thou art no less than fame hath bruited And more than may be gatherd by thy shape Let my presumption not provoke thy wrath
      [gcs-download : main] With which he yoketh your rebellious necks Razeth your cities and subverts your towns And in a moment makes them desolate
      [echo : main] Text 1: With which he yoketh your rebellious necks Razeth your cities and subverts your towns And in a moment makes them desolate
      [echo : main] Text 2: I find thou art no less than fame hath bruited And more than may be gatherd by thy shape Let my presumption not provoke thy wrath
      ```

      
## Build Tekton from Master

In order to utilize the latest features and functions of the `kfp-tekton` compiler, we suggest to install Tekton from a
nightly built or build it from the [master](https://github.com/tektoncd/pipeline/blob/master/DEVELOPMENT.md#install-pipeline) branch. 
Features that require special builds different from the 'Tested Version' will be listed below.

- [Affinity, Node Selector, and Tolerations](/sdk/FEATURES.md#affinity-node-selector-and-tolerations)

## Additional Features

### 1. TODO: remove/reword: Compile Kubeflow Pipelines as a Tekton PipelineRun

By default, a Tekton [`PipelineRun`](https://github.com/tektoncd/pipeline/blob/master/docs/pipelineruns.md#overview)
is generated by the `tkn` CLI so that users can interactively change their pipeline parameters during each execution.
However, `tkn` CLI is lagging several important features when generating `PipelineRun`.

The comparison between Tekton pipeline and Argo workflow is described in our 
[design docs](https://docs.google.com/document/d/1oXOdiItI4GbEe_qzyBmMAqfLBjfYX1nM94WHY3EPa94/edit#heading=h.f38y0bqkxo87).

The `kfp-tekton` compiler is now generating a `PipelineRun` when using `dsl-compile-tekton`.

[Here](https://github.com/tektoncd/pipeline/blob/master/docs/pipelineruns.md) is the list of supported features in `PipelineRun`.

As of today, the following `PipelineRun` features are available within `dsl-compile-tekton`:
 - Affinity
 - Node Selector
 - Tolerations

### 2. Compile Kubeflow Pipelines with Artifacts Enabled

**Prerequisite**: Install [Kubeflow Pipeline](https://www.kubeflow.org/docs/pipelines/installation/).

By default, _artifacts_ are disabled because they are dependent on Kubeflow Pipeline's
[Minio](https://docs.minio.io/) storage. When artifacts are enabled, all the output parameters are
also treated as artifacts and persisted to the default object storage. Enabling artifacts
also allows files to be downloaded or stored as artifact inputs/outputs.
Since artifacts are dependent on the Kubeflow Pipeline's deployment, the generated Tekton pipeline
must be deployed to the same namespace as Kubeflow Pipelines.

To compile Kubeflow Pipelines as a Tekton `PipelineRun`, simply add the `--enable-artifacts` argument
to your `dsl-compile-tekton` commands. Then, run the pipeline in the same namespace that is used by
Kubeflow Pipelines (typically `kubeflow`) by using the `-n` flag. e.g.:

```shell
dsl-compile-tekton --py sdk/python/tests/compiler/testdata/artifact_location.py --output pipeline.yaml --enable-artifacts
kubectl apply -f pipeline.yaml -n kubeflow
tkn pipeline start custom-artifact-location-pipeline --showlog -n kubeflow
```

You should see the below outputs saying the artifacts are stored in the object storage you specify.
```
? Value for param `secret_name` of type `string`? (Default is `mlpipeline-minio-artifact`) mlpipeline-minio-artifact
? Value for param `tag` of type `string`? (Default is `1.31.0`) 1.31.0
? Value for param `namespace` of type `string`? (Default is `kubeflow`) kubeflow
? Value for param `bucket` of type `string`? (Default is `mlpipeline`) mlpipeline
Pipelinerun started: custom-artifact-location-pipeline-run-b87bq
Waiting for logs to be available...

[generate-output : copy-artifacts] Added `storage` successfully.
[generate-output : copy-artifacts] `/tekton/results/output` -> `storage/mlpipeline/runs/custom-artifact-location-pipeline-run-b87bq/custom-artifact-location-pipeline-run-b87bq-generate-outp-7rnxv/output.txt`
[generate-output : copy-artifacts] Total: 0 B, Transferred: 6 B, Speed: 504 B/s
```


## List of Available Features

To understand how each feature is implemented and its current status, please visit the [FEATURES](FEATURES.md) doc.


## Troubleshooting

- When you encounter permission issues related to ServiceAccount, refer to [Servince Account and RBAC doc](sa-and-rbac.md)
- If you run into `bad interpreter: No such file or director` when trying to use python's venv, remove the current virtual environment in the .venv directory and create a new one using `virtualenv .venv`
